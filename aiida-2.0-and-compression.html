<!DOCTYPE html>
<html>
  <head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>
    
      enabling data compression in AiiDA 2.0 | Bonan Zhu
    
  </title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta charset="utf-8">
  <link rel="stylesheet" href="/assets/css/main.css">
  <link rel="stylesheet" href="/assets/css/syntax.css">
  <!-- Use Atom -->
  <link type="application/atom+xml" rel="alternate" href="https://zhubonan.github.io/feed.xml" title="Bonan Zhu">
  <!-- Use RSS-2.0 -->
  <!--<link href="/rss-feed.xml" type="application/rss+xml" rel="alternate" title="Bonan Zhu | Computational Materials Scientist at UCL"/>
  //-->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Code+Pro">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Quattrocento+Sans">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML">
    MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [['$', '$'], ['\\(', '\\)']]
        }
      });
  </script>
  <!-- Google Analytics -->
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', '', 'auto');
  ga('send', 'pageview');
</script>

  <!-- Use Jekyll SEO plugin -->
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>enabling data compression in AiiDA 2.0 | Bonan Zhu</title>
<meta name="generator" content="Jekyll v4.3.2">
<meta property="og:title" content="enabling data compression in AiiDA 2.0">
<meta name="author" content="Bonan Zhu">
<meta property="og:locale" content="en_US">
<meta name="description" content="AiiDA 2.0 introduces the new storage format. Rather than placing files individually shard folders, an object storage is used. It includes storage backend stores the data and allows efficient retrival of the data using the hash computed from its content. By default, the disk-objectstore is used for this. The filenames and folder structures are now stored inside the database instead.">
<meta property="og:description" content="AiiDA 2.0 introduces the new storage format. Rather than placing files individually shard folders, an object storage is used. It includes storage backend stores the data and allows efficient retrival of the data using the hash computed from its content. By default, the disk-objectstore is used for this. The filenames and folder structures are now stored inside the database instead.">
<link rel="canonical" href="https://zhubonan.github.io/aiida-2.0-and-compression">
<meta property="og:url" content="https://zhubonan.github.io/aiida-2.0-and-compression">
<meta property="og:site_name" content="Bonan Zhu">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2022-06-09T00:00:00+00:00">
<meta name="twitter:card" content="summary">
<meta property="twitter:title" content="enabling data compression in AiiDA 2.0">
<meta name="twitter:site" content="@1stbz">
<meta name="twitter:creator" content="@Bonan Zhu">
<meta name="google-site-verification" content="OpfWQC0z6rWcc-gHcJ6347BJqO7OPIcowyhcDSYKCXs">
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Bonan Zhu"},"dateModified":"2022-06-09T00:00:00+00:00","datePublished":"2022-06-09T00:00:00+00:00","description":"AiiDA 2.0 introduces the new storage format. Rather than placing files individually shard folders, an object storage is used. It includes storage backend stores the data and allows efficient retrival of the data using the hash computed from its content. By default, the disk-objectstore is used for this. The filenames and folder structures are now stored inside the database instead.","headline":"enabling data compression in AiiDA 2.0","mainEntityOfPage":{"@type":"WebPage","@id":"https://zhubonan.github.io/aiida-2.0-and-compression"},"url":"https://zhubonan.github.io/aiida-2.0-and-compression"}</script>
<!-- End Jekyll SEO tag -->

</head>

  <body>
    <div class="container">
      <header class="header">
  <h3 class="header-title">
    <a href="/">Bonan Zhu</a>
    <small class="header-subtitle">Computational Materials Scientist at UCL</small>
    <div class="menu">
  <nav class="menu-content">
    
      <a href="/about.html">About me</a>
    
      <a href="/posts.html">Posts</a>
    
      <a href="/codes.html">Codes</a>
    
      <a href="/publications.html">Publications</a>
    
      <a href="/contact.html">Contact</a>
    
  </nav>
  <nav class="social-icons">
    
  
  
    <a href="https://www.github.com/zhubonan" target="_blank"><i class="fa fa-github" aria-hidden="true"></i></a>
  

  
  
    <a href="https://twitter.com/1stbz" target="_blank"><i class="fa fa-twitter" aria-hidden="true"></i></a>
  

  
  
    <a href="/feed.xml"><i class="fa fa-rss-square" aria-hidden="true"></i></a>
  

  </nav>
</div>

  </h3>
</header>

      <div class="content-container">
        <h1>
  enabling data compression in AiiDA 2.0
</h1>

<article>
  <p>AiiDA 2.0 introduces the new storage format. Rather than placing files individually shard folders, an object storage is used. 
It includes storage backend stores the data and allows efficient retrival of the data using the hash computed from its content.
By default, the <a href="https://github.com/aiidateam/disk-objectstore">disk-objectstore</a> is used for this.
The filenames and folder structures are now stored inside the database instead.</p>

<p>This backend stores writes in two ways. First, newly added files are stored as plain files on the disk, with the filename being its hash.
This allows fully concurrent writing/reading.
The storage can be <em>optimized</em> by concatenating these <em>loose</em> files into a single <em>packed</em> file, and the offsets and lengths for reading the data out is stored in a SQLite database.
Optionally, when concatenating, the data stream may be compressed.
Compression can lead to significant spacing saving for typical text output of DFT codes. 
While the <code class="language-plaintext highlighter-rouge">verdi storage maintain</code> command can be used to perform this, it is rather conservative and does not enable compression.
To get around this, one can use <code class="language-plaintext highlighter-rouge">dostore optimize</code> to perform this task.
Current, <code class="language-plaintext highlighter-rouge">disk-objectstore</code> does not support recompressing packed objects, so one may stuck with many uncompressed streams.
In addition, when migrating from AiiDA v1, the migrated data is not compressed either.
To force the compression, the following line should be changed in <code class="language-plaintext highlighter-rouge">aiida/storage/psql_dos/migrations/utils/utils.py</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">hashkeys</span> <span class="o">=</span> <span class="n">container</span><span class="p">.</span><span class="nf">add_streamed_objects_to_pack</span><span class="p">(</span><span class="n">streams</span><span class="p">,</span> <span class="n">compress</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">open_streams</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div></div>

<p>to</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">hashkeys</span> <span class="o">=</span> <span class="n">container</span><span class="p">.</span><span class="nf">add_streamed_objects_to_pack</span><span class="p">(</span><span class="n">streams</span><span class="p">,</span> <span class="n">compress</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">open_streams</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div></div>

<p>Do note that enabling compression would make the migration slower.</p>

</article>

  <span class="post-date">
  Written on
  
  June
  9th,
  2022
  by
  
    Bonan Zhu
  
</span>



  <div class="post-date">Feel free to share!</div>
<div class="sharing-icons">
  <a href="https://twitter.com/intent/tweet?text=enabling%20data%20compression%20in%20AiiDA%202.0&url=/aiida-2.0-and-compression" target="_blank"><i class="fa fa-twitter" aria-hidden="true"></i></a>
  <a href="https://www.facebook.com/sharer/sharer.php?u=/aiida-2.0-and-compression&amp;title=enabling%20data%20compression%20in%20AiiDA%202.0" target="_blank"><i class="fa fa-facebook" aria-hidden="true"></i></a>
</div>



  <div class="related">
  <h1>You may also enjoy:</h1>
  
  <ul class="related-posts">
    
      
        
          <li>
            <h3>
              <a href="/internet-for-login-nodes">
                Access the internet (for good) on login nodes behind firewalls
                <!--<img src="https://zhubonan.github.io/images/">-->
                <!--<small>November 19, 2022</small>-->
              </a>
            </h3>
          </li>
          
        
      
        
        
      
        
          <li>
            <h3>
              <a href="/DFT-parallelisation-rule-of-thumb">
                DFT parallelisation rule of thumb
                <!--<img src="https://zhubonan.github.io/images/">-->
                <!--<small>February 15, 2022</small>-->
              </a>
            </h3>
          </li>
          
        
      
    
      
        
        
      
    
  </ul>
</div>




      </div>
      <footer class="footer">
  
  
  
    <a href="https://www.github.com/zhubonan" target="_blank"><i class="fa fa-github" aria-hidden="true"></i></a>
  

  
  
    <a href="https://twitter.com/1stbz" target="_blank"><i class="fa fa-twitter" aria-hidden="true"></i></a>
  

  
  
    <a href="/feed.xml"><i class="fa fa-rss-square" aria-hidden="true"></i></a>
  

  <div class="footer-description"><a href="/">Bonan Zhu | Computational Materials Scientist at UCL by Bonan Zhu</a></div>
</footer>

    </div>
  </body>
</html>
